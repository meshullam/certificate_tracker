{% extends 'registry/base.html' %}
{% load static %}

{% block title %}Upload Certificates - Certificate Tracker{% endblock %}

{% block content %}
<div class="page-header">
  <h2>üìÅ Certificate Management</h2>
  <p>Upload, search, and manage certificate records</p>
</div>

<div class="container">

  <!-- Search Section -->
  <div class="card">
    <h3>Search Certificates</h3>
    <div class="search-bar">
      <form method="get">
        <input 
          type="text" 
          name="q" 
          placeholder="Search by name or index number" 
          value="{{ search_query }}"
          aria-label="Search certificates">
        <button type="submit">Search</button>
      </form>
    </div>
  </div>

  <!-- Upload Section -->
  <div class="card">
    <h3>Upload Certificate Excel File</h3>
    <form action="{% url 'upload_excel' %}" method="post" enctype="multipart/form-data" id="uploadForm">
      {% csrf_token %}
      {{ form.as_p }}
      <button type="submit" id="uploadBtn">Upload</button>
      <span id="loadingSpinner" class="hidden">‚è≥ Processing...</span>
    </form>
  </div>

  <!-- Results Table Section -->
  {% if page_obj %}
  <div class="card">
    <h3>Certificate Records</h3>
    
    {% if search_query %}
      <p><strong>Search results for:</strong> "{{ search_query }}" - {{ page_obj.paginator.count }} record(s) found</p>
    {% else %}
      <p><strong>Total Records:</strong> {{ page_obj.paginator.count }}</p>
    {% endif %}

    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th>Index No</th>
            <th>Name</th>
            <th>Programme</th>
            <th>Department</th>
            <th>Slip No</th>
            <th>Status</th>
            <th>Collected At</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for rec in page_obj %}
          <tr>
            <td>{{ rec.index_number }}</td>
            <td>{{ rec.name }}</td>
            <td>{{ rec.programme }}</td>
            <td>{{ rec.department }}</td>
            <td>{{ rec.slip_number|default:"N/A" }}</td>
            <td>
              {% if rec.status == "Collected" %}
                <span style="color: #28a745; font-weight: bold;">‚úì {{ rec.status }}</span>
              {% else %}
                <span style="color: #dc3545; font-weight: bold;">‚úó {{ rec.status }}</span>
              {% endif %}
            </td>
            <td>{{ rec.collected_at|date:"Y-m-d H:i"|default:"‚Äî" }}</td>
            <td>
              {% if rec.status == "Not Collected" %}
              <form 
                action="{% url 'collect_certificate' rec.pk %}?q={{ search_query }}" 
                method="post" 
                style="display:inline;"
                onsubmit="return confirm('Mark certificate for {{ rec.name }} as collected?');">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary btn-small">Collect</button>
              </form>
              {% else %}
              <span style="color: #28a745;">‚úì Collected</span>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" style="text-align: center; padding: 20px;">
              {% if search_query %}
                No certificates found matching "{{ search_query }}"
              {% else %}
                No certificates uploaded yet. Upload an Excel file to get started.
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <div class="pagination">
      {% if page_obj.has_previous %}
      <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}">&laquo; Previous</a>
      {% endif %}

      <span class="current">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

      {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}">Next &raquo;</a>
      {% endif %}
    </div>
    {% endif %}
  </div>
  {% endif %}

  <!-- Report Section -->
  <div class="card">
    <h3>Generate Reports</h3>
    <div class="report-buttons">
      <form method="get" action="{% url 'generate_report' %}" style="display:inline;">
        <input type="hidden" name="status" value="Collected">
        <button type="submit" class="btn-dark">Download Collected Certificates Report</button>
      </form>

      <form method="get" action="{% url 'generate_report' %}" style="display:inline;">
        <input type="hidden" name="status" value="Not Collected">
        <button type="submit" class="btn-orange">Download Not Collected Certificates Report</button>
      </form>
    </div>
  </div>

</div>

<!-- JavaScript for form enhancement -->
<script>
// Add loading indicator when uploading
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    const btn = document.getElementById('uploadBtn');
    const spinner = document.getElementById('loadingSpinner');
    
    btn.disabled = true;
    btn.style.opacity = '0.5';
    spinner.classList.remove('hidden');
});

// Auto-hide messages after 5 seconds
document.addEventListener('DOMContentLoaded', function() {
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(function(alert) {
        setTimeout(function() {
            alert.style.opacity = '0';
            setTimeout(function() {
                alert.remove();
            }, 300);
        }, 5000);
    });
});
</script>
{% endblock %}